<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spoon ì˜ìƒ ë¶„ì„ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState } = React;
        
        function SpoonVideoAnalyzer() {
          const [assemblyApiKey, setAssemblyApiKey] = useState('');
          const [openaiApiKey, setOpenaiApiKey] = useState('');
          const [showAssemblyKey, setShowAssemblyKey] = useState(false);
          const [showOpenaiKey, setShowOpenaiKey] = useState(false);
          const [apiKeySet, setApiKeySet] = useState(false);
          const [videoFile, setVideoFile] = useState(null);
          const [videoSrc, setVideoSrc] = useState('');
          const [fileName, setFileName] = useState('');
          const [japaneseText, setJapaneseText] = useState('');
          const [koreanTranslation, setKoreanTranslation] = useState('');
          const [userPrompt, setUserPrompt] = useState('');
          const [adContent, setAdContent] = useState(null);
          const [isProcessing, setIsProcessing] = useState(false);
          const [isGeneratingAds, setIsGeneratingAds] = useState(false);
          const [processingStep, setProcessingStep] = useState('');
          const [progress, setProgress] = useState(0);
          const [error, setError] = useState('');
          const [showPromptInput, setShowPromptInput] = useState(false);

          const handleApiKeySubmit = () => {
            if (assemblyApiKey.trim().length > 10 && openaiApiKey.trim().length > 10) {
              setApiKeySet(true);
              setError('');
            } else {
              setError('AssemblyAIì™€ OpenAI API í‚¤ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
          };

          const handleFileChange = (e) => {
            const file = e.target.files?.[0];
            if (!file) return;
            if (!file.type.startsWith('video/')) {
              alert('ë™ì˜ìƒ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
              return;
            }
            
            setVideoFile(file);
            setFileName(file.name);
            if (videoSrc) URL.revokeObjectURL(videoSrc);
            const url = URL.createObjectURL(file);
            setVideoSrc(url);
            setAdContent(null);
            setUserPrompt('');
            setShowPromptInput(false);
            startAnalysis(file);
          };

          const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

          const startAnalysis = async (file) => {
            setIsProcessing(true);
            setError('');
            setJapaneseText('');
            setKoreanTranslation('');
            
            try {
              setProcessingStep('ì˜ìƒ íŒŒì¼ì„ Base64ë¡œ ì¸ì½”ë”© ì¤‘...');
              setProgress(10);
              
              const uploadUrl = await uploadFile(file);
              setProgress(30);
              
              setProcessingStep('ìŒì„± ì¸ì‹ ìš”ì²­ ì¤‘...');
              const transcriptId = await startTranscription(uploadUrl);
              setProgress(40);
              
              setProcessingStep('ìŒì„± ì¸ì‹ ì²˜ë¦¬ ì¤‘... (1-2ë¶„ ì†Œìš”)');
              const transcription = await pollTranscription(transcriptId);
              setJapaneseText(transcription);
              setProgress(70);
              
              setProcessingStep('GPTë¡œ í•œê¸€ ë²ˆì—­ ì¤‘...');
              const translation = await translateWithGPT(transcription);
              setKoreanTranslation(translation);
              setProgress(100);
              
              await sleep(500);
              setIsProcessing(false);
              setShowPromptInput(true);
              
            } catch (err) {
              console.error('ë¶„ì„ ì˜¤ë¥˜:', err);
              setError('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
              setIsProcessing(false);
            }
          };

          const handleGenerateAds = async () => {
            if (!userPrompt.trim()) {
              alert('ê´‘ê³  ë¬¸êµ¬ ìƒì„± ì§€ì‹œì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
              return;
            }

            setIsGeneratingAds(true);
            setError('');
            
            try {
              const ads = await generateAds(japaneseText, koreanTranslation, userPrompt);
              setAdContent(ads);
              setIsGeneratingAds(false);
            } catch (err) {
              console.error('ê´‘ê³  ìƒì„± ì˜¤ë¥˜:', err);
              setError('ê´‘ê³  ë¬¸êµ¬ ìƒì„± ì‹¤íŒ¨: ' + err.message);
              setIsGeneratingAds(false);
            }
          };

          const uploadFile = async (file) => {
            const base64Data = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => {
                const base64 = reader.result.split(',')[1];
                resolve(base64);
              };
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });
            
            const response = await fetch('/api/upload', {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({
                apiKey: assemblyApiKey,
                base64Data: base64Data,
                contentType: file.type
              })
            });
            
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (errorData.error || response.status));
            }
            
            const data = await response.json();
            return data.upload_url;
          };

          const startTranscription = async (audioUrl) => {
            const response = await fetch('/api/transcribe', {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({
                audio_url: audioUrl,
                language_code: 'ja',
                apiKey: assemblyApiKey
              })
            });
            
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error('ìŒì„± ì¸ì‹ ì‹œì‘ ì‹¤íŒ¨: ' + (errorData.error || response.status));
            }
            
            const data = await response.json();
            return data.id;
          };

          const pollTranscription = async (transcriptId) => {
            while (true) {
              const response = await fetch('/api/status?id=' + transcriptId + '&apiKey=' + assemblyApiKey);
              
              if (!response.ok) {
                const errorData = await response.json();
                throw new Error('ìŒì„± ì¸ì‹ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ' + (errorData.error || response.status));
              }
              
              const data = await response.json();
              
              if (data.status === 'completed') return data.text;
              if (data.status === 'error') throw new Error('ìŒì„± ì¸ì‹ ì‹¤íŒ¨');
              
              await sleep(3000);
            }
          };

          const translateWithGPT = async (text) => {
            const response = await fetch('/api/translate', {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({
                text: text,
                apiKey: openaiApiKey
              })
            });
            
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error('ë²ˆì—­ ì‹¤íŒ¨: ' + (errorData.error || response.status));
            }
            
            const data = await response.json();
            return data.translation;
          };

          const generateAds = async (japaneseText, koreanText, userPrompt) => {
            const response = await fetch('/api/generate-ads', {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({
                japaneseText: japaneseText,
                koreanText: koreanText,
                userPrompt: userPrompt,
                apiKey: openaiApiKey
              })
            });
            
            if (!response.ok) {
              const errorData = await response.json();
              throw new Error('ê´‘ê³  ë¬¸êµ¬ ìƒì„± ì‹¤íŒ¨: ' + (errorData.error || response.status));
            }
            
            const data = await response.json();
            return data;
          };

          const copyToClipboard = (text) => {
            navigator.clipboard.writeText(text);
            alert('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
          };

          if (!apiKeySet) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-purple-900 via-purple-800 to-pink-900 flex items-center justify-center p-6">
                <div className="bg-white bg-opacity-10 backdrop-blur-md rounded-3xl p-8 max-w-md w-full border border-white border-opacity-20">
                  <div className="text-center mb-6">
                    <h2 className="text-3xl font-bold text-white mb-2">API í‚¤ ì…ë ¥</h2>
                    <p className="text-purple-200">AssemblyAIì™€ OpenAI API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                  </div>
                  
                  <div className="space-y-4">
                    <div>
                      <label className="text-white text-sm mb-2 block">AssemblyAI API Key</label>
                      <div className="relative">
                        <input
                          type={showAssemblyKey ? 'text' : 'password'}
                          value={assemblyApiKey}
                          onChange={(e) => setAssemblyApiKey(e.target.value)}
                          placeholder="AssemblyAI API Key"
                          className="w-full bg-black bg-opacity-30 text-white px-4 py-3 rounded-xl border border-purple-300 border-opacity-30 focus:outline-none focus:border-pink-400 pr-12"
                        />
                        <button
                          onClick={() => setShowAssemblyKey(!showAssemblyKey)}
                          className="absolute right-3 top-1/2 -translate-y-1/2 text-purple-300"
                        >
                          {showAssemblyKey ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}
                        </button>
                      </div>
                    </div>

                    <div>
                      <label className="text-white text-sm mb-2 block">OpenAI API Key</label>
                      <div className="relative">
                        <input
                          type={showOpenaiKey ? 'text' : 'password'}
                          value={openaiApiKey}
                          onChange={(e) => setOpenaiApiKey(e.target.value)}
                          placeholder="OpenAI API Key (sk-...)"
                          className="w-full bg-black bg-opacity-30 text-white px-4 py-3 rounded-xl border border-purple-300 border-opacity-30 focus:outline-none focus:border-pink-400 pr-12"
                          onKeyPress={(e) => e.key === 'Enter' && handleApiKeySubmit()}
                        />
                        <button
                          onClick={() => setShowOpenaiKey(!showOpenaiKey)}
                          className="absolute right-3 top-1/2 -translate-y-1/2 text-purple-300"
                        >
                          {showOpenaiKey ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}
                        </button>
                      </div>
                    </div>
                    
                    {error && (
                      <div className="bg-red-500 bg-opacity-20 border border-red-400 border-opacity-30 rounded-xl p-3">
                        <p className="text-red-200 text-sm">{error}</p>
                      </div>
                    )}
                    
                    <button
                      onClick={handleApiKeySubmit}
                      className="w-full bg-gradient-to-r from-pink-500 to-purple-500 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg transition-all"
                    >
                      ì‹œì‘í•˜ê¸°
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-purple-900 via-purple-800 to-pink-900">
              <header className="bg-black bg-opacity-30 backdrop-blur-md border-b border-white border-opacity-20">
                <div className="max-w-7xl mx-auto px-6 py-4">
                  <h1 className="text-2xl font-bold text-white">ğŸ™ï¸ Spoon ì˜ìƒ ë¶„ì„ê¸°</h1>
                </div>
              </header>

              <main className="max-w-7xl mx-auto px-6 py-12">
                <div className="text-center mb-12">
                  <h2 className="text-5xl font-bold text-white mb-4">
                    ì¼ë³¸ì–´ ì˜ìƒì„ ë¶„ì„í•˜ê³ <br />
                    <span className="text-transparent bg-clip-text bg-gradient-to-r from-pink-300 to-purple-300">
                      ê´‘ê³  ë¬¸êµ¬ë¥¼ ìë™ ìƒì„±
                    </span>
                  </h2>
                </div>

                <div className="bg-white bg-opacity-10 backdrop-blur-md rounded-3xl p-8 mb-8 border border-white border-opacity-20">
                  <input
                    type="file"
                    accept="video/*"
                    onChange={handleFileChange}
                    id="videoUpload"
                    className="hidden"
                    disabled={isProcessing}
                  />
                  <label htmlFor="videoUpload" className={`block cursor-pointer ${isProcessing ? 'opacity-50' : ''}`}>
                    <div className="border-2 border-dashed border-purple-300 border-opacity-50 rounded-2xl p-12 text-center hover:border-pink-300 transition-all">
                      <h3 className="text-white text-xl font-semibold mb-2">ì¼ë³¸ì–´ ì˜ìƒ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</h3>
                      <p className="text-purple-200">MP4, MOV, AVI ë“± (ì‘ì€ íŒŒì¼ ì¶”ì²œ)</p>
                      {fileName && <p className="text-green-300 font-semibold mt-4">âœ“ {fileName}</p>}
                    </div>
                  </label>
                </div>

                {error && (
                  <div className="bg-red-500 bg-opacity-20 rounded-2xl p-4 mb-8">
                    <p className="text-red-100">{error}</p>
                  </div>
                )}

                {isProcessing && (
                  <div className="bg-gradient-to-r from-pink-500/20 to-purple-500/20 rounded-3xl p-8 mb-8">
                    <div className="flex flex-col items-center gap-4">
                      <div className="animate-spin rounded-full h-12 w-12 border-4 border-pink-300 border-t-transparent"></div>
                      <p className="text-white text-lg font-semibold">{processingStep}</p>
                      <div className="w-full max-w-md">
                        <div className="bg-black bg-opacity-30 rounded-full h-3 overflow-hidden">
                          <div className="bg-gradient-to-r from-pink-500 to-purple-500 h-full transition-all duration-500" style={{ width: progress + '%' }}></div>
                        </div>
                        <p className="text-purple-200 text-sm text-center mt-2">{progress}%</p>
                      </div>
                    </div>
                  </div>
                )}

                {videoSrc && !isProcessing && japaneseText && (
                  <div className="space-y-8">
                    <div className="bg-black bg-opacity-40 rounded-3xl p-6">
                      <h3 className="text-white text-2xl font-bold mb-4">ğŸ“¹ ì—…ë¡œë“œëœ ì˜ìƒ</h3>
                      <video key={videoSrc} controls className="w-full rounded-xl max-h-96 bg-black">
                        <source src={videoSrc} type={videoFile?.type || 'video/mp4'} />
                      </video>
                    </div>

                    <div className="bg-white bg-opacity-10 rounded-3xl p-8">
                      <h3 className="text-white text-2xl font-bold mb-4">ğŸ‡¯ğŸ‡µ ì¸ì‹ëœ ì¼ë³¸ì–´ ìŒì„±</h3>
                      <div className="bg-black bg-opacity-30 rounded-xl p-6">
                        <p className="text-purple-100 whitespace-pre-line leading-relaxed text-lg">{japaneseText}</p>
                      </div>
                    </div>

                    <div className="bg-white bg-opacity-10 rounded-3xl p-8">
                      <h3 className="text-white text-2xl font-bold mb-4">ğŸ‡°ğŸ‡· í•œê¸€ ë²ˆì—­ (GPT-4o-mini)</h3>
                      <div className="bg-black bg-opacity-30 rounded-xl p-6">
                        <p className="text-purple-100 whitespace-pre-line leading-relaxed text-lg">{koreanTranslation}</p>
                      </div>
                    </div>

                    {showPromptInput && (
                      <div className="bg-gradient-to-br from-yellow-500/30 to-orange-500/30 rounded-3xl p-8 border border-yellow-300 border-opacity-40">
                        <h3 className="text-white text-2xl font-bold mb-4">ğŸ’¡ ê´‘ê³  ë¬¸êµ¬ ìƒì„± ì§€ì‹œì‚¬í•­</h3>
                        <p className="text-yellow-100 mb-4">ìœ„ ë²ˆì—­ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬, ì–´ë–¤ ìŠ¤íƒ€ì¼ì˜ ê´‘ê³  ë¬¸êµ¬ë¥¼ ì›í•˜ì‹œëŠ”ì§€ ì‘ì„±í•´ì£¼ì„¸ìš”.</p>
                        <textarea
                          value={userPrompt}
                          onChange={(e) => setUserPrompt(e.target.value)}
                          placeholder="ì˜ˆì‹œ: ì Šì€ ì—¬ì„± íƒ€ê²Ÿìœ¼ë¡œ ê°ì„±ì ì´ê³  ë”°ëœ»í•œ í†¤ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. ASMRê³¼ íë§ì„ ê°•ì¡°í•´ì£¼ì„¸ìš”."
                          className="w-full bg-black bg-opacity-30 text-white px-4 py-3 rounded-xl border border-yellow-300 border-opacity-30 focus:outline-none focus:border-yellow-400 h-32 resize-none"
                          disabled={isGeneratingAds}
                        />
                        <button
                          onClick={handleGenerateAds}
                          disabled={isGeneratingAds}
                          className={`mt-4 w-full bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-8 py-4 rounded-xl font-bold text-lg hover:shadow-2xl transition-all ${isGeneratingAds ? 'opacity-50 cursor-not-allowed' : ''}`}
                        >
                          {isGeneratingAds ? 'ìƒì„± ì¤‘...' : 'ê´‘ê³  ë¬¸êµ¬ ìƒì„±í•˜ê¸° âœ¨'}
                        </button>
                      </div>
                    )}

                    {adContent && (
                      <div className="bg-gradient-to-br from-pink-500/30 to-purple-500/30 rounded-3xl p-8">
                        <h3 className="text-white text-3xl font-bold mb-6">âœ¨ ìƒì„±ëœ ê´‘ê³  ë¬¸êµ¬</h3>
                        
                        <div className="space-y-6">
                          <div className="bg-black bg-opacity-30 rounded-xl p-6">
                            <div className="flex justify-between items-center mb-3">
                              <h4 className="text-pink-300 font-bold text-lg">ğŸ“± Meta ê´‘ê³ ì œëª© (27byte)</h4>
                              <button onClick={() => copyToClipboard(adContent.meta_title)} className="text-white bg-pink-500 px-3 py-1 rounded text-sm hover:bg-pink-600">ë³µì‚¬</button>
                            </div>
                            <p className="text-white">{adContent.meta_title}</p>
                          </div>

                          <div className="bg-black bg-opacity-30 rounded-xl p-6">
                            <div className="flex justify-between items-center mb-3">
                              <h4 className="text-pink-300 font-bold text-lg">ğŸ“± Meta ê¸°ë³¸ë¬¸êµ¬ (72byte)</h4>
                              <button onClick={() => copyToClipboard(adContent.meta_body)} className="text-white bg-pink-500 px-3 py-1 rounded text-sm hover:bg-pink-600">ë³µì‚¬</button>
                            </div>
                            <p className="text-white">{adContent.meta_body}</p>
                          </div>

                          <div className="bg-black bg-opacity-30 rounded-xl p-6">
                            <div className="flex justify-between items-center mb-3">
                              <h4 className="text-pink-300 font-bold text-lg">ğŸ“± Meta í–‰ë™ìœ ë„ (100byte)</h4>
                              <button onClick={() => copyToClipboard(adContent.meta_cta)} className="text-white bg-pink-500 px-3 py-1 rounded text-sm hover:bg-pink-600">ë³µì‚¬</button>
                            </div>
                            <p className="text-white">{adContent.meta_cta}</p>
                          </div>

                          <div className="bg-black bg-opacity-30 rounded-xl p-6">
                            <div className="flex justify-between items-center mb-3">
                              <h4 className="text-purple-300 font-bold text-lg">ğŸµ TikTok ê¸°ë³¸ë¬¸êµ¬ (100byte)</h4>
                              <button onClick={() => copyToClipboard(adContent.tiktok_body)} className="text-white bg-purple-500 px-3 py-1 rounded text-sm hover:bg-purple-600">ë³µì‚¬</button>
                            </div>
                            <p className="text-white">{adContent.tiktok_body}</p>
                          </div>

                          <div className="bg-black bg-opacity-30 rounded-xl p-6">
                            <div className="flex justify-between items-center mb-3">
                              <h4 className="text-purple-300 font-bold text-lg">ğŸµ TikTok í–‰ë™ìœ ë„ (100byte)</h4>
                              <button onClick={() => copyToClipboard(adContent.tiktok_cta)} className="text-white bg-purple-500 px-3 py-1 rounded text-sm hover:bg-purple-600">ë³µì‚¬</button>
                            </div>
                            <p className="text-white">{adContent.tiktok_cta}</p>
                          </div>

                          <div className="bg-black bg-opacity-30 rounded-xl p-6">
                            <div className="flex justify-between items-center mb-3">
                              <h4 className="text-red-300 font-bold text-lg">ğŸ“º YouTube ê´‘ê³ ì œëª© (90byte)</h4>
                              <button onClick={() => copyToClipboard(adContent.youtube_title)} className="text-white bg-red-500 px-3 py-1 rounded text-sm hover:bg-red-600">ë³µì‚¬</button>
                            </div>
                            <p className="text-white">{adContent.youtube_title}</p>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </main>
            </div>
          );
        }

        ReactDOM.render(<SpoonVideoAnalyzer />, document.getElementById('root'));
    </script>
</body>
</html>
